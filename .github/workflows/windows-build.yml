name: Windows Build

permissions:
  contents: write

on:
  push:
    tags:
      - "v*"

concurrency:
  group: windows-build
  cancel-in-progress: true

jobs:
  build-windows:
    name: Build Windows App
    runs-on: windows-latest
    # do not map secrets at job-level to minimize blast radius; set them on steps that need them

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for signing secrets
        id: secrets_check
        shell: pwsh
        run: |
          # Write whether cert and gpg secrets are present to outputs (do not print secret values)
          $hasCert = if ('${{ secrets.CERT_PFX }}' -ne '' -and '${{ secrets.CERT_PASSWORD }}' -ne '') { 'true' } else { '' }
          $hasGpg = if ('${{ secrets.GPG_PRIVATE_KEY }}' -ne '') { 'true' } else { '' }
          Write-Output "have_cert=$hasCert" >> $env:GITHUB_OUTPUT
          Write-Output "have_gpg=$hasGpg" >> $env:GITHUB_OUTPUT

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: "latest"

      - name: Cache pnpm store and node_modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.pnpm-store
            node_modules
          key: pnpm-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            pnpm-${{ runner.os }}-

      - name: Install dependencies
        run: pnpm install

      - name: Install Rust via rustup (stable)
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          Write-Host "Downloading rustup-init.exe"
          Invoke-WebRequest -Uri 'https://win.rustup.rs' -UseBasicParsing -OutFile 'rustup-init.exe'
          Write-Host "Running rustup-init.exe (non-interactive)"
          Start-Process -FilePath .\rustup-init.exe -ArgumentList '-y','--no-modify-path','--default-toolchain','stable' -Wait
          Remove-Item .\rustup-init.exe
          # Add cargo bin to PATH for remaining steps
          $cargo = "$env:USERPROFILE\\.cargo\\bin"
          Add-Content -Path $env:GITHUB_PATH -Value $cargo
          Write-Host "rustup and rustc versions:"
          rustup --version
          rustc --version

      - name: Cache Cargo registry and git
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
          key: cargo-registry-${{ runner.os }}-${{ hashFiles('src-tauri/Cargo.lock') }}
          restore-keys: |
            cargo-registry-${{ runner.os }}-

      - name: Cache Cargo build target (optional)
        uses: actions/cache@v4
        with:
          path: src-tauri/target
          key: cargo-target-${{ runner.os }}-${{ hashFiles('src-tauri/Cargo.lock') }}
          restore-keys: |
            cargo-target-${{ runner.os }}-

      - name: Compute release version from tag
        id: ver
        shell: pwsh
        run: |
          # GITHUB_REF example: refs/tags/v0.1.1
          $ref = $env:GITHUB_REF
          $ver = $ref -replace '^refs/tags/v', ''
          Write-Output "version=$ver" >> $env:GITHUB_OUTPUT

      - name: Remove .gitkeep files in src-tauri
        shell: pwsh
        run: |
          Get-ChildItem -Path 'src-tauri' -Recurse -Filter '.gitkeep' -ErrorAction SilentlyContinue | ForEach-Object { Remove-Item -LiteralPath $_.FullName -Force }

      - name: Generate Tauri icons
        run: pnpm tauri icon ./app-icon.svg

      - name: Generate prerendered icons
        run: pnpm icons

      - name: Build Tauri (release)
        run: pnpm tauri build --no-bundle

      - name: Gather release binaries to sign
        if: ${{ steps.secrets_check.outputs.have_cert == 'true' }}
        id: gather_sign_files
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $root = Join-Path $PWD 'src-tauri\target\release'
          Write-Host "Searching for .exe and .dll under $root"
          $items = Get-ChildItem -Path $root -Recurse -Include *.exe,*.dll -File -ErrorAction SilentlyContinue | Select-Object -ExpandProperty FullName
          if (-not $items) {
            Write-Host "No binaries found to sign"
            Write-Output "files=" >> $env:GITHUB_OUTPUT
            exit 0
          }
          $joined = $items -join ';'
          Write-Host "Found $($items.Count) files to sign"
          Write-Output "files=$joined" >> $env:GITHUB_OUTPUT

      - name: Sign internal release binaries (Authenticode)
        if: ${{ steps.secrets_check.outputs.have_cert == 'true' && steps.gather_sign_files.outputs.files != '' }}
        uses: ./.github/actions/authenticode-sign
        with:
          files: ${{ steps.gather_sign_files.outputs.files }}
        env:
          CERT_PFX: ${{ secrets.CERT_PFX }}
          CERT_PASSWORD: ${{ secrets.CERT_PASSWORD }}

      - name: Bundle Tauri
        run: pnpm tauri bundle

      - name: Bundle portable
        run: pnpm bundle:portable

      - name: Collect artifacts
        id: collect
        shell: pwsh
        env:
          VERSION: ${{ steps.ver.outputs.version }}
        run: |
          New-Item -ItemType Directory -Path artifacts -Force | Out-Null

          $nsis = Get-ChildItem -Path 'src-tauri\target\release\bundle\nsis' -Filter '*.exe' -Recurse -ErrorAction SilentlyContinue | Select-Object -Last 1
          if (-not $nsis) { Write-Error "NSIS installer not found in src-tauri\target\release\bundle\nsis"; exit 1 }
          $nsisDest = Join-Path $PWD $nsis.Name
          Copy-Item $nsis.FullName -Destination (Join-Path $PWD 'artifacts' $nsis.Name)

          $portable = Get-ChildItem -Path 'src-tauri\target\release\bundle\portable_win' -Filter '*.exe' -Recurse -ErrorAction SilentlyContinue | Select-Object -Last 1
          if (-not $portable) { Write-Error "Portable exe not found in src-tauri\target\release\bundle\portable_win"; exit 1 }
          Copy-Item $portable.FullName -Destination (Join-Path $PWD 'artifacts' $portable.Name)

          Write-Output "nsis_artifact=$($nsis.Name)" >> $env:GITHUB_OUTPUT
          Write-Output "portable_artifact=$($portable.Name)" >> $env:GITHUB_OUTPUT

      - name: Sign artifacts with GPG
        if: ${{ steps.secrets_check.outputs.have_gpg == 'true' }}
        uses: ./.github/actions/gpg-sign
        with:
          files: |
            artifacts/${{ steps.collect.outputs.nsis_artifact }};artifacts/${{ steps.collect.outputs.portable_artifact }}
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}

      - name: Sign bundled artifacts (Authenticode)
        if: ${{ steps.secrets_check.outputs.have_cert == 'true' }}
        uses: ./.github/actions/authenticode-sign
        with:
          files: |
            artifacts/${{ steps.collect.outputs.nsis_artifact }};artifacts/${{ steps.collect.outputs.portable_artifact }}
        env:
          CERT_PFX: ${{ secrets.CERT_PFX }}
          CERT_PASSWORD: ${{ secrets.CERT_PASSWORD }}

      - name: Verify Authenticode signatures on artifacts
        if: ${{ steps.secrets_check.outputs.have_cert == 'true' }}
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $nsis = Join-Path $PWD "artifacts/${{ steps.collect.outputs.nsis_artifact }}"
          $portable = Join-Path $PWD "artifacts/${{ steps.collect.outputs.portable_artifact }}"

          $files = @($nsis, $portable)
          foreach ($f in $files) {
            if (Test-Path $f) {
              Write-Host "Running signtool verify on: $f"
              & signtool verify /pa /v $f
              if ($LASTEXITCODE -ne 0) {
                Write-Error "signtool verification failed for $f"
                exit 1
              }
            } else {
              Write-Host "Not found, skipping verification: $f"
            }
          }

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: Switchboot ${{ steps.ver.outputs.version }}
          body: |
            Switchboot ${{ steps.ver.outputs.version }} released
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload artifacts to release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/${{ steps.collect.outputs.nsis_artifact }}
            artifacts/${{ steps.collect.outputs.portable_artifact }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
